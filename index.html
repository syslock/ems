<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<script src="js/jquery.js"></script>
		<script>
			$(document).ready( init )
			function init()
			{
				query_string = $(document)[0].location.search
				if( query_string )
				{
					$.get( 'ems.wsgi'+query_string, parse_result )
				}
				hide_register()
				$.get('ems.wsgi?do=status', function(result)
				{
					result = parse_result( result )
					if( result.login )
					{
						show_overview( result )
					}
					else
					{
						show_login()
					}
				})
			}
			
			function parse_result( result )
			{
				try
				{
					var False = false;
					var True = true;
					var None = undefined;
					result = eval( "("+result+")" )
					$(".ems-error")[0].innerHTML = ""
				}
				catch( e )
				{
					$(".ems-error")[0].innerHTML = "Error parsing response: "+e;
				}
				if( result.error )
				{
					$(".ems-error")[0].innerHTML = result.error.trace.join("");
				}
				else $(".ems-error")[0].innerHTML;
				return result;
			}
			
			function show_login()
			{
				$("title")[0].innerHTML = "Anmeldung"
				$(".ems-heading")[0].innerHTML = "Anmeldung"
				$(".ems-login")[0].style.display = ""
				$(".menu-logout")[0].style.display = "none"
				$(".ems-new-entry")[0].style.display = "none"
			}
			
			function show_overview( session )
			{
				$("title")[0].innerHTML = "Übersicht"
				$(".ems-heading")[0].innerHTML = "Übersicht"
				$(".ems-login")[0].style.display = "none"
				$(".menu-logout")[0].style.display = ""
				$(".ems-new-entry")[0].style.display = ""
				load_entries( session )
			}
			
			function logout()
			{
				$.get( "ems.wsgi?do=logout", function(result)
				{
					result = parse_result( result )
					if( result.succeeded ) { init() }
				})
			}
			
			function login()
			{
				$.get( "ems.wsgi?do=login&nick="+$("input.login-nick")[0].value
						+"&password="+$("input.login-password")[0].value, 
				function(result)
				{
					result = parse_result( result )
					if( result.succeeded ) { init() }
				})
				$("input.login-password")[0].value = ""
			}
			
			function register()
			{
				if( $("input.login-password")[0].value
					!= $("input.register-password")[0].value )
				{
					$("ems-error")[0].innerHTML = "Passwörter müssen übereinstimmen"
					$("input.login-password")[0].value = ""
					$("input.register-password")[0].value = ""
					return;
				}
				$.get( "ems.wsgi?do=register&nick="+$("input.login-nick")[0].value
						+"&password="+$("input.login-password")[0].value
						+"&email="+$("input.register-email")[0].value
						+"&fullname="+$("input.register-fullname")[0].value,
				function(result)
				{
					result = parse_result( result )
					if( result.succeeded ) { init() }
				})
				$("input.login-password")[0].value = ""
				$("input.register-password")[0].value = ""
			}
			
			function hide_register()
			{
				$(".ems-register")[0].style.display="none"
				$(".login-submit")[0].style.display=""
				$(".login-register")[0].style.display=""
			}
			
			function show_register()
			{
				$(".ems-register")[0].style.display=""
				$(".login-submit")[0].style.display="none"
				$(".login-register")[0].style.display="none"
			}
			
			function new_entry( object_id )
			{
				if( object_id==undefined )
				{
					$.ajax({
						url : "ems.wsgi?do=store&type=application/x-obj.entry",
						async : false,
						success :
					function( result )
					{
						result = parse_result( result )
						if( result.succeeded && resul.object_id!=undefined )
						{
							new_entry( result.object_id )
						}
					}})
					return undefined;
				}
				else
				{
					var entry = $("#ems-entry-template").first().clone(true)[0];
					entry.id = "ems-entry-"+String(object_id)
					entry.style.display = ""
					$(".ems-entry").first().before( entry )
					entry.data = {
						"object_id" : object_id,
					}
					return entry;
				}
			}
			
			function load_entries( session )
			{
				if( session )
				{
					$.get("ems.wsgi?do=get&id="+session.login.id+"&view=meta",
					function( result )
					{
						result = parse_result( result )
						for( i in result.children )
						{
							var entry_id = result.children[i]
							$.ajax({
								url : "ems.wsgi?do=get&id="+entry_id+"&view=meta",
								async : false,
								success :
							function( result )
							{
								result = parse_result( result )
								if( result.type == "application/x-obj.entry" )
								{
									var entry = $("ems-entry-"+String(result.id))[0]
									if( !entry )
									{
										entry = new_entry( result.id )
									}
									entry_heading = $(".entry-heading",entry)[0]
									if( result.title )
									{
										entry_heading.innerHTML = result.title
									}
									entry_content = $(".entry-content",entry)[0]
									for( j in result.children )
									{
										var part_id = result.children[j]
										$.ajax({
											url : "ems.wsgi?do=get&id="+part_id+"&view=meta",
											async : false,
											success :
										function( result )
										{
											result = parse_result( result )
											if( result.type == "text/plain" )
											{
												$.ajax({
													url : "ems.wsgi?do=get&id="+result.id,
													async : false,
													success :
												function( result )
												{
													var span = $("#entry-text-template").first().clone()[0]
													span.id = "entry-text-"+String(entry_id)+"-"+String(part_id)
													span.style.display = ""
													span.innerHTML = result
													entry_content.appendChild( span );
												}})
											}
										}})
									}
								}
							}})
						}
					})
				}
			}
		</script>
	</head>
	<body>
		<div class="ems-menu">
			<button class="menu-logout" onclick="logout()" style="display:none">
				Abmelden
			</button>
		</div>
		<h1 class="ems-heading"></h1>
		<div class="ems-login" style="display:none">
			<div class="login-nick">
				<p class="login-nick">Benutzername:</p>
				<input type="text" class="login-nick"/>
			</div>
			<div class="login-password">
				<p class="login-password">Passwort:</p>
				<input type="password" class="login-password"/>
			</div>
			<button class="login-submit" onclick="login()">Anmelden</button>
			<button class="login-register" onclick="show_register()">
				Noch nicht registriert?
			</button>
		</div>
		<div class="ems-register" style="display:none">
			<div class="register-password">
				<p class="register-password">Passwort wiederholen:</p>
				<input type="password" class="register-password"/>
			</div>
			<div class="register-fullname">
				<p class="register-fullname">Vor- und Nachname:</p>
				<input type="text" class="register-fullname"/>
			</div>
			<div class="register-email">
				<p class="register-email">E-Mail-Adresse:</p>
				<input type="text" class="register-email"/>
			</div>
			<button class="register-submit" onclick="register()">
				Registrieren
			</button>
		</div>
		<div class="ems-content">
			<button class="ems-new-entry" onclick="new_entry()" style="display:none">
				Beitrag erstellen
			</button>
			<div id="ems-entry-template" class="ems-entry" style="display:none">
				<h2 class="entry-heading"></h2>
				<div class="entry-content"></div>
				<button class="entry-edit">Bearbeiten</button>
			</div>
			<span id="entry-text-template" class="entry-text" style="display:none"></span>
		</div>
		<div class="ems-status">
			<pre class="ems-error"></pre>
		</div>
	</body>
</html>
