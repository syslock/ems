<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>${app.config.sitename}</title>
		<link id="main_style" rel="stylesheet" type="text/css" href="" />
		<script data-main="js/main.js" src="js/require-jquery.js"></script>
		<script>
			var global_status = undefined;
			var global_user = undefined;
			function init()
			{
				$.get('ems.wsgi?do=status',
				function(result)
				{
					result = parse_result( result )
					global_status = result
					if( result.login )
					{
						$(".menu-login")[0].style.display="none";
						$(".menu-nick-caption")[0].style.display="";
						$(".menu-nick")[0].innerHTML=result.login.nick;
						$(".menu-logout")[0].style.display="";
						$.get('ems.wsgi?do=get&view=all&id='+String(result.login.id),
						function(result)
						{
							result = parse_result( result )
							global_user = result[0]
						})
					}
					else
					{
						$(".menu-login")[0].style.display="";
						$(".menu-nick-caption")[0].style.display="none";
						$(".menu-nick")[0].innerHTML="";
						$(".menu-logout")[0].style.display="none";
					}
					apply_page_filter();
					var ws = WebSocket('ws://localhost/ems/ems.wsgi?do=event_monitor');
					ws.onmessage = function( msg ) {
						var result = parse_result( msg.data );
						if( result.succeeded ) {
							$('.page-events').empty();
							for( var i in result.objects ) {
								var obj = result.objects[i];
								var img = $('<img>').attr( {'class': 'status-icon', 'src': get_status_icon(obj.type),
									'title': obj.title+' ('+obj.type+')'} );
								$('.page-events').append( img );
							}
						}
					};
				})
			}
			
			function get_status_icon( type ) {
				var fallback = 'tango-scalable/status/image-missing.svg';
				var generic_type = type.match(/^([^/]*)\//)[1];
				var mappings = {
					'application/x-obj.group' : 'tango-scalable/apps/system-users.svg',
					'application/x-obj.entry' : 'tango-scalable/mimetypes/x-office-document.svg',
					'text/plain' : 'tango-scalable/mimetypes/text-x-generic.svg',
					'image' : 'tango-scalable/mimetypes/image-x-generic.svg'
				};
				
				return mappings[type] ? mappings[type] : mappings[generic_type] ? mappings[generic_type] : fallback;
			}
		</script>
	</head>
	<body>
		<span class="page-menu">
			<%include file="/elements/global_menu.html" args="title=app.config.sitename" />
			<span class="page-widgets">
				<button class="new-entry-button" onclick="new_response(global_user)">
					${_("Beitrag erstellen")}
				</button>
				<span class="page-filter">
					<span class="page-filter-title">${_("Filter:")}</span>
					<span class="page-filter-view"></span>
				</span>
				<span class="page-events"></span>
			</span>
		</span>
		<div class="ems-content"></div>
		<%include file="/elements/status_box.html" />
		<%include file="/elements/group_template.html" />
		<%include file="/elements/user_template.html" />
		<%include file="/elements/entry_template.html" />
		<%include file="/elements/text_template.html" />
		<%include file="/elements/new_entry.html" />
		<%include file="/elements/upload_dialog.html" />
	</body>
</html>
